---
title: "R Notebook"
output: html_notebook
---

```{r}
library(sp)
library(dplyr)
setwd("../")
getwd()
```

```{r}
load('../output/nyc_nbhd.RData')
taxi1<-read.csv('../output/taxi2016_1.csv')
taxi2<-read.csv('../output/taxi2016_2.csv')
weather<-read.csv('../data/weather_small.csv',as.is=TRUE)
#nyc_neighborhoods
```

```{r}
taxiall <- rbind(taxi1,taxi2)
```


```{r}
nbhd<-function(ll){
  colnames(ll)=c('lon','lat')
  ll_spdf<-ll
  coordinates(ll_spdf)= ~lon + lat
  proj4string(ll_spdf) <- proj4string(nyc_nbhd)
  match<-over(ll_spdf, nyc_nbhd)
  return(match[,c(1,3)])
}

#taxi1
pickupnbhd1<-taxi1%>%select(PU.lon,PU.lat)%>%nbhd()
colnames(pickupnbhd1)<-c('PUnbhd','PUnbhdBorough')


dropoffnbhd1<-taxi1%>%select(DO.lon,DO.lat)%>%nbhd()
colnames(dropoffnbhd1)<-c('DOnbhd','DOnbhdBorough')

#taxi2
pickupnbhd2<-taxi2%>%select(PU.lon,PU.lat)%>%nbhd()
colnames(pickupnbhd2)<-c('PUnbhd','PUnbhdBorough')


dropoffnbhd2<-taxi2%>%select(DO.lon,DO.lat)%>%nbhd()
colnames(dropoffnbhd2)<-c('DOnbhd','DOnbhdBorough')
```

```{r}
updatetaxi1<-cbind(taxi1,pickupnbhd1,dropoffnbhd1)
updatetaxi2<-cbind(taxi2,pickupnbhd2,dropoffnbhd2)
taxidata<-rbind(updatetaxi1,updatetaxi2)
```


```{r}
#A<-taxiall%>%select(PU.lon,PU.lat)%>%nbhd()
```

```{r}
#unique(taxiall$neighborhood)
```


```{r}
#add columns
taxidata<-taxidata%>%mutate(pu_date=substring(tpep_pickup_datetime,1,10),do_date=substring(tpep_dropoff_datetime,1,10))
taxidatatemp<-taxidata%>%mutate(pu_wl=if_else(PU.Borough %in% c('Manhattan', 'Bronx', 'Unknown'), 'NY CITY CENTRAL PARK, NY US',
                             if_else(PU.Borough %in% c('Brooklyn','Queens'), 'LA GUARDIA AIRPORT, NY US','WOODBRIDGE TWP 1.1 ESE, NJ US')))
taxidatatemp<-taxidatatemp%>%mutate(do_wl=if_else(DO.Borough %in% c('Manhattan', 'Bronx', 'Unknown'), 'NY CITY CENTRAL PARK, NY US',
                             if_else(DO.Borough %in% c('Brooklyn','Queens'), 'LA GUARDIA AIRPORT, NY US','WOODBRIDGE TWP 1.1 ESE, NJ US')))

#left join weather data
pu_weather<-taxidatatemp%>%left_join(weather,by=c('pu_date'='DATE','pu_wl'='NAME'))%>%select(BAD_WEATHER)
colnames(pu_weather)<-'pu_weather'
do_weather<-taxidatatemp%>%left_join(weather,by=c('do_date'='DATE','do_wl'='NAME'))%>%select(BAD_WEATHER)
colnames(do_weather)<-'do_weather'
taxi<-cbind(taxidata,pu_weather,do_weather)
```


```{r}
#save(taxi, file = "/Users/yeyejiang/Desktop/taxidata.RData")
save(taxi, file = "../output/taxidata.RData")
```

